# ブランチ戦略

本ドキュメントは、Git-flow に準拠したブランチ戦略を定めたものです。

> **step-by-step 手順については [運用手順書（Runbook）](./runbook.md) を参照してください。**

## 目次

1. [ブランチ構成](#ブランチ構成)
2. [ブランチ命名規則](#ブランチ命名規則)
3. [機能開発フロー](#機能開発フロー)
4. [リリースブランチの運用](#リリースブランチの運用)
5. [Hot-fix の運用](#hot-fix-の運用)
6. [非 Hot-fix 修正の運用](#非-hot-fix-修正の運用)
7. [PR とレビューの原則](#pr-とレビューの原則)

---

## ブランチ構成

Git-flow に準拠し、以下のブランチを使用します。

| ブランチ種別 | ブランチ名 | 説明 |
|------------|-----------|-----|
| メインブランチ | `master` | 本番リリース用。vX.Y.Z タグはこのブランチ上にのみ存在する |
| 開発ブランチ | `develop` | 次期リリースの開発用。すべての feature コミットはここにマージされる |
| 機能ブランチ | `feature/*` | 新機能開発用 |
| リリースブランチ | `release/vX.Y.Z` | リリース準備用 |
| Hot-fix ブランチ | `hotfix/*` | 緊急修正用 |

---

## ブランチ命名規則

### Semantic Versioning (Sem-Ver)

バージョン番号は Semantic Versioning に従います。

```
vX.Y.Z
```

- **X (Major)**: 後方互換性のない変更
- **Y (Minor)**: 後方互換性のある機能追加
- **Z (Patch)**: 後方互換性のあるバグ修正

### ブランチ名の例

- `feature/add-user-authentication`
- `feature/improve-performance`
- `release/v1.2.0`
- `release/v2.0.0`
- `hotfix/fix-critical-security-issue`
- `hotfix/fix-payment-error`

---

## 機能開発フロー

機能開発は以下のフローで行います。

1. `develop` ブランチから `feature/*` ブランチを作成
2. 機能を実装し、コミット
3. `develop` ブランチに対する PR を作成
4. レビュー承認後、マージ

> **重要**: 機能開発（`feat:` プレフィックスを持つコミット）は `feature` ブランチで行い、PR を通じて `develop` ブランチにマージする必要があります。`master` や `release` ブランチに直接 feature コミットをプッシュしないでください。

📘 **手順の詳細**: [Runbook - 新機能を開発する](./runbook.md#新機能を開発する)

---

## リリースブランチの運用

### リリースブランチの作成タイミング

- 次のリリースに含める機能が `develop` ブランチに揃った時点
- リリーススケジュールに基づいて計画的に作成

### Feature-Freeze 状態

リリースブランチが作成されると、**Feature-Freeze** 状態となります。

#### Feature-Freeze 状態とは

- `release/vX.Y.Z` ブランチでは新機能の追加は禁止
- 許可される変更:
  - バグ修正
  - ドキュメント修正
  - リリースに必要な設定変更
- 新機能は次のリリースサイクルで `develop` ブランチから開発を継続

📘 **手順の詳細**: [Runbook - リリースブランチを作成する](./runbook.md#リリースブランチを作成する)

---

## Hot-fix の運用

### Hot-fix とは

本番環境で発生した緊急の問題を修正するための変更です。

### 原則

- **master ブランチに対する PR として修正を作成**
- レビューを受け、承認後にマージ
- Hot-fix は `master` へのマージ後、`develop` にも反映する必要がある

📘 **手順の詳細**: [Runbook - Hot-fix を適用する](./runbook.md#hot-fix-を適用する)

---

## 非 Hot-fix 修正の運用

### 非 Hot-fix 修正とは

- 機能追加を含まないバグ修正や改善
- 緊急性のない修正
- リファクタリング

### 運用方法

非 Hot-fix 修正は、現在の `release` ブランチ（例: `release/v1.2.0`）で Feature-Freeze 中に対応します。

- 既存の release ブランチに対してバグ修正のみを適用
- 機能追加は禁止
- 修正後、新しいパッチバージョン（例: v1.2.1）としてリリース

📘 **手順の詳細**: [Runbook - リリース後のバグ修正（非 Hot-fix）](./runbook.md#リリース後のバグ修正非-hot-fix)

---

## PR とレビューの原則

### 基本原則

> **原則としてすべての変更は PR で管理し、レビューを受けること**

### PR 作成のルール

1. **すべてのコード変更は PR を通じて行う**
   - 直接のブランチへの push は禁止
   - 緊急時でも PR 経由でマージする

2. **適切なレビュアーを設定する**
   - 最低 1 名以上のレビューを必須とする
   - コードオーナーが設定されている場合は自動的にレビュアーに追加

3. **PR テンプレートに従う**
   - 変更内容の説明
   - テスト方法
   - 影響範囲

4. **CI/CD チェックをパスしてからマージ**
   - 自動テストがすべてパスしていること
   - リンターチェックがパスしていること

### レビューの観点

- コードの品質と可読性
- セキュリティー上の問題がないか
- パフォーマンスへの影響
- テストの網羅性
- ドキュメントの更新が必要か

---

## 関連ドキュメント

- [デプロイ戦略](./deployment-strategy.md)
- [運用手順書（Runbook）](./runbook.md)
