# デプロイ戦略

本ドキュメントは、各環境へのデプロイ戦略とタグ運用を定めたものです。

## 目次

1. [環境構成](#環境構成)
2. [ブランチ・タグと環境の対応](#ブランチタグと環境の対応)
3. [タグの種類と命名規則](#タグの種類と命名規則)
4. [RC タグの作成場所](#rc-タグの作成場所)
5. [デプロイ方式](#デプロイ方式)
6. [アプリの配布（Distribute）](#アプリの配布distribute)

---

## 環境構成

| 環境 | 略称 | 用途 |
|------|------|------|
| 開発環境 | DEV (Develop) | 開発中の機能確認用 |
| ステージング環境 | STG (Staging) | リリース候補の動作確認・審査用 |
| 本番環境 | PRD (Production) | エンドユーザー向け本番環境 |

---

## ブランチ・タグと環境の対応

| ブランチ / タグ | デプロイ先 | デプロイ方式 |
|-----------------|------------|--------------|
| `develop` ブランチ (HEAD) | DEV 環境 | 自動 / 半自動 / 手動 |
| `vX.Y.Z-rc.N` タグ | STG 環境 | 自動 / 半自動 / 手動 |
| `vX.Y.Z` タグ (master 上) | PRD 環境 | 原則として手動 / 半自動 |

### 詳細

#### DEV 環境 (develop ブランチ)

- `develop` ブランチの HEAD を DEV 環境にデプロイします
- デプロイは自動、半自動、または手動で実行可能です
- 開発中の最新機能を継続的に確認するために使用します

#### STG 環境 (vX.Y.Z-rc.N タグ)

- `vX.Y.Z-rc.N` タグを STG 環境にデプロイします
- リリース前の動作確認と、モバイルアプリの場合は審査提出に使用します
- RC タグは以下のブランチ上に作成される可能性があります：
  - `release/vX.Y.Z` ブランチ
  - `hotfix/*` ブランチ
  - `master` ブランチ

#### PRD 環境 (vX.Y.Z タグ)

- `vX.Y.Z` タグを PRD 環境にデプロイします
- **`vX.Y.Z` タグは `master` ブランチ上にのみ存在すること**
- 本番デプロイは原則として手動、または半自動（承認フロー付き）で実行します

---

## タグの種類と命名規則

### タグ命名規則

| タグ種別 | 形式 | 説明 |
|---------|------|-----|
| リリース候補タグ | `vX.Y.Z-rc.N` | STG 環境での動作確認・審査用 |
| 本番リリースタグ | `vX.Y.Z` | PRD 環境リリース用。**master ブランチ上にのみ存在** |

### Semantic Versioning

バージョン番号は Semantic Versioning (Sem-Ver) に従います。

```
vX.Y.Z
```

- **X (Major)**: 後方互換性のない変更
- **Y (Minor)**: 後方互換性のある機能追加
- **Z (Patch)**: 後方互換性のあるバグ修正

### 例

- リリース候補: `v1.2.0-rc.1`, `v1.2.0-rc.2`, `v1.2.0-rc.3`
- 本番リリース: `v1.2.0`, `v1.2.1`, `v2.0.0`

---

## RC タグの作成場所

`vX.Y.Z-rc.N` タグは、以下のいずれのブランチ上にも作成される可能性があります。

| ブランチ | シナリオ |
|----------|----------|
| `release/vX.Y.Z` | 通常のリリースフロー |
| `hotfix/*` | 緊急修正のリリース前確認 |
| `master` | Hot-fix の直接適用後の確認 |

### 原則

- RC タグはリリース前の動作確認を目的として作成します
- RC 番号は `1` から開始し、修正のたびにインクリメントします
- 例: `v1.2.0-rc.1` → `v1.2.0-rc.2` → `v1.2.0-rc.3`

---

## デプロイ方式

### 自動デプロイ

CI/CD パイプラインがブランチやタグの変更を検知して自動的にデプロイを実行します。

- **対象**: DEV 環境、STG 環境（オプション）
- **トリガー**: develop ブランチへの push、RC タグの作成

### 半自動デプロイ

CI/CD パイプラインがデプロイを準備し、承認後に実行します。

- **対象**: STG 環境、PRD 環境
- **トリガー**: 手動承認、またはタグ作成後の承認フロー

### 手動デプロイ

運用担当者がデプロイコマンドを手動で実行します。

- **対象**: PRD 環境（推奨）
- **実行者**: リリース権限を持つ担当者

---

## アプリの配布（Distribute）

モバイルアプリの場合、デプロイではなく配布（distribute）を行います。

### iOS アプリ

| 環境 | 配布先 | 用途 |
|------|--------|------|
| DEV | Ad-hoc / 開発者向け | 開発中の確認 |
| STG | TestFlight (内部テスト) | RC の動作確認・審査 |
| PRD | App Store | エンドユーザー向け |

### Android アプリ

| 環境 | 配布先 | 用途 |
|------|--------|------|
| DEV | 内部配布 / Firebase App Distribution | 開発中の確認 |
| STG | Google Play 内部テストトラック | RC の動作確認・審査 |
| PRD | Google Play 製品版トラック | エンドユーザー向け |

### 審査対応

モバイルアプリの場合、ストア審査があるため、以下のフローに従います。

1. 最新の RC タグでビルドを作成
2. 審査用として提出
3. 審査パス後、`master` へマージし `vX.Y.Z` タグを作成
4. 審査リジェクトの場合、修正後に新しい RC を作成して再提出

---

## デプロイフロー図

### Web アプリケーション

```
[develop] ──────────────────────────────→ DEV 環境
    │
    ↓ feature 開発完了
[release/vX.Y.Z] 作成
    │
    ↓
[vX.Y.Z-rc.N] タグ ────────────────────→ STG 環境
    │
    ↓ 動作確認 OK
[master] へマージ
    │
    ↓
[vX.Y.Z] タグ ─────────────────────────→ PRD 環境
```

### モバイルアプリ

```
[develop] ──────────────────────────────→ DEV 配布
    │
    ↓ feature 開発完了
[release/vX.Y.Z] 作成
    │
    ↓
[vX.Y.Z-rc.N] タグ ────────────────────→ STG 配布 (TestFlight / 内部テスト)
    │
    ↓ 審査提出 → 審査パス
[master] へマージ
    │
    ↓
[vX.Y.Z] タグ ─────────────────────────→ PRD 配布 (Store リリース)
```

---

## 関連ドキュメント

- [ブランチ戦略](./branching-strategy.md)
- [運用手順書（Runbook）](./runbook.md)
